name: CI - Selenium Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  testng-tests:
    name: TestNG Tests (Chrome)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Run TestNG tests
        run: mvn test -DsuiteXmlFile=src/test/resources/testng-chrome.xml -Dheadless=true
        continue-on-error: true

      - name: Debug - List allure and surefire results
        if: always()
        run: |
          echo "=== target/allure-results/ ==="
          ls -la target/allure-results/ 2>/dev/null || echo "EMPTY or NOT FOUND"
          echo "=== target/surefire-reports/ ==="
          ls -la target/surefire-reports/ 2>/dev/null || echo "EMPTY or NOT FOUND"

      - name: Ensure allure-results directory exists
        if: always()
        run: mkdir -p target/allure-results

      - name: Upload TestNG Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-testng
          path: target/allure-results/
          retention-days: 1
          if-no-files-found: warn

  cucumber-tests:
    name: Cucumber BDD Tests (Chrome)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Run Cucumber tests
        run: mvn test -Dcucumber=true -Dheadless=true
        continue-on-error: true

      - name: Ensure allure-results directory exists
        if: always()
        run: mkdir -p target/allure-results

      - name: Upload Cucumber Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-cucumber
          path: target/allure-results/
          retention-days: 1
          if-no-files-found: warn

  deploy-report:
    name: Generate & Deploy Allure Reports to GitHub Pages
    needs: [testng-tests, cucumber-tests]
    if: always()
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Create site directory
        run: mkdir -p site/testng site/cucumber

      # â”€â”€ TestNG Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download TestNG Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results-testng
          path: allure-results-testng/
        continue-on-error: true

      - name: Generate TestNG Allure report
        uses: simple-elf/allure-report-action@master
        continue-on-error: true
        with:
          allure_results: allure-results-testng
          allure_report: site/testng
          keep_reports: 20

      # â”€â”€ Cucumber Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download Cucumber Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results-cucumber
          path: allure-results-cucumber/
        continue-on-error: true

      - name: Generate Cucumber Allure report
        uses: simple-elf/allure-report-action@master
        continue-on-error: true
        with:
          allure_results: allure-results-cucumber
          allure_report: site/cucumber
          keep_reports: 20

      # â”€â”€ Index page linking both reports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create index page
        run: |
          cat > site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>Test Reports â€“ Genesys-Demo</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d1117; color: #e6edf3; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; gap: 24px; }
              h1 { font-size: 1.5rem; color: #58a6ff; margin: 0; }
              p { color: #8b949e; margin: 0; font-size: 0.9rem; }
              .cards { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
              a.card { display: flex; flex-direction: column; gap: 8px; padding: 24px 32px; border: 1px solid #30363d; border-radius: 12px; background: #161b22; color: #e6edf3; text-decoration: none; transition: border-color .2s, background .2s; min-width: 200px; text-align: center; }
              a.card:hover { border-color: #58a6ff; background: #1c2128; }
              a.card .icon { font-size: 2rem; }
              a.card .label { font-weight: 600; font-size: 1rem; }
              a.card .sub { font-size: 0.8rem; color: #8b949e; }
            </style>
          </head>
          <body>
            <h1>Genesys-Demo â€” Test Reports</h1>
            <p>Hybrid Test Automation Framework (Selenium + TestNG + Cucumber)</p>
            <div class="cards">
              <a class="card" href="./testng/">
                <span class="icon">ðŸ“Š</span>
                <span class="label">Allure TestNG Report</span>
                <span class="sub">Unit &amp; integration tests</span>
              </a>
              <a class="card" href="./cucumber/">
                <span class="icon">ðŸ¥’</span>
                <span class="label">Allure Cucumber Report</span>
                <span class="sub">BDD scenarios</span>
              </a>
            </div>
          </body>
          </html>
          EOF

      # â”€â”€ Deploy to GitHub Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload site to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4